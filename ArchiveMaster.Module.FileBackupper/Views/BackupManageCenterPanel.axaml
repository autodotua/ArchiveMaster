<v:PanelBase
    x:Class="ArchiveMaster.Views.BackupManageCenterPanel"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:c="using:ArchiveMaster.Converters"
    xmlns:ctrl="clr-namespace:FzLib.Avalonia.Controls;assembly=FzLib.Avalonia"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:g="clr-namespace:GroupBox.Avalonia.Controls;assembly=GroupBox.Avalonia"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:ui="http://schemas.modernwpf.com/2019"
    xmlns:v="using:ArchiveMaster.Views"
    xmlns:vm="using:ArchiveMaster.ViewModels"
    d:DesignHeight="450"
    d:DesignWidth="800"
    x:DataType="vm:BackupTasksViewModel"
    mc:Ignorable="d">
    <v:PanelBase.PanelContent>
        <Grid RowDefinitions="Auto,8,*,8,2*">
            <ToggleSwitch
                IsChecked="{Binding Config.EnableBackgroundBackup}"
                OffContent="自动备份总开关"
                OnContent="自动备份总开关" />
            <g:GroupBox
                Grid.Row="2"
                Header="任务状态">
                <v:BackupTaskDataGrid
                    IsEnabled="{Binding CanSelectTasks}"
                    ItemsSource="{Binding Tasks}"
                    SelectedItem="{Binding SelectedTask}" />
            </g:GroupBox>
            <TabControl
                Grid.Row="4"
                SelectedIndex="{Binding SelectedTabIndex}">
                <TabItem Header="快照">
                    <DataGrid
                        IsReadOnly="True"
                        ItemsSource="{Binding Snapshots}"
                        SelectedItem="{Binding SelectedSnapShot}">
                        <DataGrid.Columns>
                            <DataGridTextColumn
                                Binding="{Binding Snapshot.BeginTime, Converter={StaticResource DateTimeConverter}}"
                                Header="开始时间" />
                            <DataGridTextColumn
                                Binding="{Binding Snapshot.EndTime, Converter={StaticResource DateTimeConverter}}"
                                Header="完成时间" />
                            <DataGridTemplateColumn
                                CanUserResize="False"
                                Header="类型">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel
                                            Margin="4,0"
                                            Orientation="Horizontal"
                                            Spacing="8">
                                            <TextBlock
                                                IsVisible="{Binding Snapshot.IsFull}"
                                                Text="全量" />
                                            <TextBlock
                                                IsVisible="{Binding !Snapshot.IsFull}"
                                                Text="增量" />
                                            <TextBlock
                                                IsVisible="{Binding Snapshot.IsVirtual}"
                                                Text="虚拟" />
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn
                                Binding="{Binding CreatedFileCount}"
                                Header="新增文件数" />
                            <DataGridTextColumn
                                Binding="{Binding DeletedFileCount}"
                                Header="删除文件数" />
                            <DataGridTextColumn
                                Binding="{Binding ModifiedFileCount}"
                                Header="修改文件数" />
                            <DataGridTemplateColumn
                                CanUserResize="False"
                                Header="操作">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel
                                            Orientation="Horizontal"
                                            Spacing="8">
                                            <Button
                                                Classes="Link"
                                                Command="{Binding $parent[DataGrid].DataContext.JumpToLogsBySnapshotCommand}"
                                                CommandParameter="{Binding .}"
                                                Content="日志" />
                                            <Button
                                                Classes="Link"
                                                Command="{Binding $parent[DataGrid].DataContext.JumpToRestoreBySnapshotCommand}"
                                                CommandParameter="{Binding .}"
                                                Content="查看文件" />
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>
                <TabItem Header="文件列表">
                    <v:TreeFileDataGrid
                        ItemsSource="{Binding TreeFiles}"
                        RootDepth="0"
                        SelectedItem="{Binding SelectedFile}">
                        <v:TreeFileDataGrid.Styles>
                            <Style Selector="DataGridRow">
                                <Setter Property="ContextMenu">
                                    <ContextMenu>
                                        <MenuItem
                                            Command="{Binding $parent[TabItem].DataContext.SaveAsCommand}"
                                            CommandParameter="{Binding .}"
                                            Header="另存为" />
                                    </ContextMenu>
                                </Setter>
                            </Style>
                        </v:TreeFileDataGrid.Styles>
                    </v:TreeFileDataGrid>
                </TabItem>
                <TabItem Header="日志">
                    <DataGrid
                        IsReadOnly="True"
                        ItemsSource="{Binding Logs}">
                        <DataGrid.Resources>
                            <c:LogLevelConverter x:Key="LogLevelConverter" />
                        </DataGrid.Resources>
                        <DataGrid.Columns>
                            <DataGridTextColumn
                                Binding="{Binding Type, Converter={StaticResource LogLevelConverter}, Mode=OneWay}"
                                Header="类型" />
                            <DataGridTextColumn
                                Binding="{Binding Time, Converter={StaticResource DateTimeConverter}}"
                                Header="时间" />
                            <DataGridTextColumn
                                Binding="{Binding Message}"
                                Header="信息" />
                            <DataGridTemplateColumn
                                CanUserResize="False"
                                Header="操作">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel
                                            Orientation="Horizontal"
                                            Spacing="8">
                                            <Button
                                                Classes="Link"
                                                Command="{Binding $parent[DataGrid].DataContext.ShowDetailCommand}"
                                                CommandParameter="{Binding .}"
                                                Content="详情"
                                                IsVisible="{Binding Detail, Converter={StaticResource NotNullConverter}}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                </TabItem>
            </TabControl>
        </Grid>
    </v:PanelBase.PanelContent>
</v:PanelBase>