<v:PanelBase
    x:Class="ArchiveMaster.Views.BackupManageCenterPanel"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:c="using:ArchiveMaster.Converters"
    xmlns:ctrl="clr-namespace:FzLib.Avalonia.Controls;assembly=FzLib.Avalonia"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:e="using:ArchiveMaster.Enums"
    xmlns:g="clr-namespace:GroupBox.Avalonia.Controls;assembly=GroupBox.Avalonia"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:me="using:FzLib.Avalonia.MarkupExtensions"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:ui="http://schemas.modernwpf.com/2019"
    xmlns:v="using:ArchiveMaster.Views"
    xmlns:vm="using:ArchiveMaster.ViewModels"
    d:DesignHeight="450"
    d:DesignWidth="800"
    x:DataType="vm:BackupTasksViewModel"
    mc:Ignorable="d">
    <v:PanelBase.PanelContent>
        <Grid RowDefinitions="Auto,8,*,8,2*">
            <ToggleSwitch
                IsChecked="{Binding Config.EnableBackgroundBackup}"
                OffContent="自动备份总开关"
                OnContent="自动备份总开关" />
            <g:GroupBox
                Grid.Row="2"
                Header="任务状态">
                <v:BackupTaskDataGrid
                    IsEnabled="{Binding CanSelectTasks}"
                    ItemsSource="{Binding Tasks}"
                    SelectedItem="{Binding SelectedTask}" />
            </g:GroupBox>
            <TabControl
                Grid.Row="4"
                IsEnabled="{Binding SelectedTask, Converter={StaticResource NotNullConverter}}"
                SelectedIndex="{Binding SelectedTabIndex}">
                <TabItem Header="快照">
                    <DataGrid
                        IsReadOnly="True"
                        ItemsSource="{Binding Snapshots}"
                        SelectedItem="{Binding SelectedSnapShot}">
                        <DataGrid.Columns>
                            <DataGridTextColumn
                                Binding="{Binding Snapshot.BeginTime, Converter={StaticResource DateTimeConverter}}"
                                Header="开始时间" />
                            <DataGridTextColumn
                                Binding="{Binding Snapshot.EndTime, Converter={StaticResource DateTimeConverter}}"
                                Header="完成时间" />
                            <DataGridTextColumn
                                Binding="{Binding Snapshot.Type, Converter={StaticResource DescriptionConverter}}"
                                Header="完成时间" />
                            <DataGridTextColumn
                                Binding="{Binding CreatedFileCount}"
                                Header="新增文件数" />
                            <DataGridTextColumn
                                Binding="{Binding DeletedFileCount}"
                                Header="删除文件数" />
                            <DataGridTextColumn
                                Binding="{Binding ModifiedFileCount}"
                                Header="修改文件数" />
                            <DataGridTemplateColumn
                                CanUserResize="False"
                                Header="操作">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel
                                            Orientation="Horizontal"
                                            Spacing="8">
                                            <DropDownButton
                                                Classes="Link"
                                                Content="操作">
                                                <DropDownButton.Flyout>
                                                    <MenuFlyout>
                                                        <MenuItem
                                                            Command="{Binding $parent[DataGrid].DataContext.JumpToLogsBySnapshotCommand}"
                                                            CommandParameter="{Binding .}"
                                                            Header="日志" />
                                                        <MenuItem
                                                            Command="{Binding $parent[DataGrid].DataContext.JumpToRestoreBySnapshotCommand}"
                                                            CommandParameter="{Binding .}"
                                                            Header="查看文件" />
                                                    </MenuFlyout>
                                                </DropDownButton.Flyout>
                                            </DropDownButton>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>
                <TabItem Header="文件列表">
                    <v:TreeFileDataGrid
                        ColumnIsCheckedIndex="-1"
                        ItemsSource="{Binding TreeFiles}"
                        RootDepth="0"
                        SelectedItem="{Binding SelectedFile}">
                        <v:TreeFileDataGrid.Styles>
                            <Style Selector="DataGridRow">
                                <Setter Property="ContextMenu">
                                    <ContextMenu>
                                        <MenuItem
                                            Command="{Binding $parent[TabItem].DataContext.SaveAsCommand}"
                                            CommandParameter="{Binding .}"
                                            Header="另存为" />
                                    </ContextMenu>
                                </Setter>
                            </Style>
                        </v:TreeFileDataGrid.Styles>
                    </v:TreeFileDataGrid>
                </TabItem>
                <TabItem Header="日志">
                    <DataGrid
                        IsReadOnly="True"
                        ItemsSource="{Binding Logs}">
                        <DataGrid.Resources>
                            <c:LogLevelConverter x:Key="LogLevelConverter" />
                        </DataGrid.Resources>
                        <DataGrid.Columns>
                            <DataGridTextColumn
                                Binding="{Binding Type, Converter={StaticResource LogLevelConverter}, Mode=OneWay}"
                                Header="类型" />
                            <DataGridTextColumn
                                Binding="{Binding Time, Converter={StaticResource DateTimeConverter}}"
                                Header="时间" />
                            <DataGridTextColumn
                                Binding="{Binding Message}"
                                Header="信息" />
                            <DataGridTemplateColumn
                                CanUserResize="False"
                                Header="操作">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel
                                            Orientation="Horizontal"
                                            Spacing="8">
                                            <Button
                                                Classes="Link"
                                                Command="{Binding $parent[DataGrid].DataContext.ShowDetailCommand}"
                                                CommandParameter="{Binding .}"
                                                Content="详情"
                                                IsVisible="{Binding Detail, Converter={StaticResource NotNullConverter}}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                </TabItem>
                <TabItem Header="操作">
                    <StackPanel>
                        <g:GroupBox Header="立即备份">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <Button
                                        Command="{Binding MakeBackupCommand}"
                                        Content="全量备份">
                                        <Button.CommandParameter>
                                            <e:SnapshotType>Full</e:SnapshotType>
                                        </Button.CommandParameter>
                                    </Button>
                                    <Button
                                        Command="{Binding MakeBackupCommand}"
                                        Content="虚拟全量备份">
                                        <Button.CommandParameter>
                                            <e:SnapshotType>VirtualFull</e:SnapshotType>
                                        </Button.CommandParameter>
                                    </Button>
                                    <Button
                                        Command="{Binding MakeBackupCommand}"
                                        Content="增量备份">
                                        <Button.CommandParameter>
                                            <e:SnapshotType>Increment</e:SnapshotType>
                                        </Button.CommandParameter>
                                    </Button>
                                    <Button
                                        Command="{Binding CancelMakingBackupCommand}"
                                        Content="取消备份"
                                        IsEnabled="{Binding MakeBackupCommand.IsRunning}" />
                                </StackPanel>
                                <TextBlock>
                                    <Run FontWeight="Bold">全量备份：</Run>
                                    <Run>完整备份每一个文件</Run>
                                </TextBlock>
                                <TextBlock>
                                    <Run FontWeight="Bold">虚拟全量备份：</Run>
                                    <Run>类似全量备份，但仅将元数据写入数据库，不进行真正的文件复制</Run>
                                </TextBlock>
                                <TextBlock>
                                    <Run FontWeight="Bold">增量备份：</Run>
                                    <Run>在已有全量快照的前提下，仅备份和记录与上一个快照有差异的部分</Run>
                                </TextBlock>
                            </StackPanel>
                        </g:GroupBox>
                    </StackPanel>
                </TabItem>
            </TabControl>
        </Grid>
    </v:PanelBase.PanelContent>
</v:PanelBase>