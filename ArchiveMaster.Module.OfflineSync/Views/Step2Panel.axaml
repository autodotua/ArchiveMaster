<v:OfflineSyncPanelBase
    x:Class="ArchiveMaster.Views.Step2Panel"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:ui="http://schemas.modernwpf.com/2019"
    xmlns:v="clr-namespace:ArchiveMaster.Views"
    xmlns:enums="clr-namespace:ArchiveMaster.Enums"
    xmlns:vm="clr-namespace:ArchiveMaster.ViewModels"
    xmlns:c="clr-namespace:ArchiveMaster.Converters"
    x:Name="root"
    d:DesignHeight="450"
    d:DesignWidth="800"
    mc:Ignorable="d">
    <v:OfflineSyncPanelBase.Styles>
        <Style Selector="TextBox">
            <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled" />
        </Style>
    </v:OfflineSyncPanelBase.Styles>
    <v:OfflineSyncPanelBase.Resources>
        <c:SyncFilePathConverter x:Key="SyncFilePathConverter" />
    </v:OfflineSyncPanelBase.Resources>
    <v:OfflineSyncPanelBase.PanelContent>
        <Grid RowDefinitions="*,8,Auto" ColumnDefinitions="*,16,2*">

            <Grid RowDefinitions="Auto,8,*">
                <StackPanel
                    Margin="8"
                    IsEnabled="{Binding CanEditConfigs}"
                    Spacing="8">
                    <Grid ColumnDefinitions="96,8,*,8,Auto" RowDefinitions="Auto,8,Auto">
                        <TextBlock
                            VerticalAlignment="Center"
                            Text="异地快照文件：" />
                        <TextBox
                            Grid.Column="2"
                            MaxLines="3"
                            Text="{Binding OffsiteSnapshot}"
                            TextWrapping="Wrap" />
                        <Button
                            Command="{Binding BrowseOffsiteSnapshotCommand}"
                            Grid.Column="4"
                            Classes="Middle"
                            Content="浏览.." />

                        <TextBlock
                            Grid.Row="2"
                            VerticalAlignment="Center"
                            Text="本地搜索目录：" />
                        <TextBox
                            Grid.Row="2"
                            Grid.Column="2"
                            Watermark="在选择的目录中搜索需要同步的目录；一行一项"
                            AcceptsReturn="True"
                            MaxLines="3"
                            Text="{Binding LocalDir}" />
                        <Button
                            Grid.Row="2"
                            Grid.Column="4"
                            Classes="Middle"
                            Command="{Binding BrowseLocalDirCommand}"
                            Content="添加.." />

                    </Grid>
                    <Button HorizontalAlignment="Right"
                            Classes="Long"
                            Command="{Binding MatchDirsCommand}"
                            Content="1. 匹配目录" />
                </StackPanel>
                <DataGrid
                    Grid.Row="2"
                    AutoGenerateColumns="False"
                    CanUserReorderColumns="True"
                    ItemsSource="{Binding MatchingDirs}">
                    <DataGrid.Columns>
                        <DataGridTextColumn
                            Binding="{Binding OffsiteDir}"
                            Header="异地目录"
                            IsReadOnly="True" />
                        <DataGridTextColumn
                            Binding="{Binding LocalDir}"
                            Header="本地目录" />
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
            <Grid Grid.Column="2" RowDefinitions="Auto,8,*,8,Auto">
                <StackPanel
                    Margin="8"
                    IsEnabled="{Binding CanEditConfigs}"
                    Spacing="8">
                    <Grid ColumnDefinitions="96,8,*,8,Auto">
                        <TextBlock
                            Grid.Row="4"
                            VerticalAlignment="Center"
                            Text="导出补丁目录：" />
                        <TextBox
                            Grid.Row="4"
                            Grid.Column="2"
                            Text="{Binding PatchDir}" />
                        <Button x:Name="btnBrowse"
                                Grid.Row="4"
                                Grid.Column="4"
                                Command="{Binding BrowsePatchDirCommand}"
                                Classes="Middle"
                                Content="浏览.." />
                    </Grid>
                    <Grid ColumnDefinitions="96,8,*,8,Auto">
                        <TextBlock
                            VerticalAlignment="Center"
                            Text="黑名单：" />
                        <TextBox
                            Grid.Column="2"
                            Watermark="可以是文件名，也可以是完整路径；一行一项"
                            AcceptsReturn="True"
                            MaxLines="5"
                            Text="{Binding BlackList}" />
                        <CheckBox
                            Grid.Column="4"
                            VerticalAlignment="Center"
                            Content="正则"
                            Classes="Middle"
                            Height="{Binding #btnBrowse.Bounds.Height}"
                            IsChecked="{Binding BlackListUseRegex}" />
                    </Grid>
                    <Button HorizontalAlignment="Right"
                            Classes="Long"
                            Content="2. 查找更改" />
                </StackPanel>
                <DataGrid
                    Grid.Row="2"
                    AutoGenerateColumns="False"
                    CanUserReorderColumns="True" CanUserResizeColumns="True"
                    ItemsSource="{Binding Files}">
                    <DataGrid.Columns>
                        <DataGridTemplateColumn
                            Width="36"
                            CanUserReorder="False"
                            CanUserResize="False"
                            CanUserSort="False">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate x:DataType="{x:Type vm:SyncFileInfo}">
                                    <CheckBox
                                        Margin="8,0"
                                        IsChecked="{Binding IsChecked}"
                                        IsEnabled="{Binding DataContext.CanEditConfigs, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type UserControl}}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn
                            CanUserResize="False"
                            Header="完成">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock
                                        Margin="16,0"
                                        VerticalAlignment="Center"
                                        Foreground="Green"
                                        Text="●"
                                        IsVisible="{Binding Complete}" />

                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn
                            Width="200"
                            Binding="{Binding Name}"
                            Header="文件名"
                            IsReadOnly="True" />
                        <DataGridTemplateColumn
                            Width="200"
                            Header="文件路径">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock
                                        VerticalAlignment="Center"
                                        HorizontalAlignment="Left"
                                        TextWrapping="Wrap"
                                        Margin="8,4"
                                        Text="{Binding ., Converter={StaticResource SyncFilePathConverter}}" />

                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn
                            Binding="{Binding LastWriteTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}"
                            CanUserResize="False"
                            Header="修改时间"
                            IsReadOnly="True" />
                        <DataGridTextColumn
                            Binding="{Binding Length, Converter={StaticResource FileLength2StringConverter}}"
                            CanUserResize="False"
                            Header="大小"
                            IsReadOnly="True" />

                        <DataGridTemplateColumn
                            CanUserResize="False"
                            Header="更新类型"
                            SortMemberPath="UpdateType">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock
                                        Margin="16,0"
                                        VerticalAlignment="Center"
                                        Text="{Binding UpdateType, Converter={StaticResource DescriptionConverter}}">
                                        <Interaction.Behaviors>
                                            <DataTriggerBehavior Binding="{Binding UpdateType}"
                                                                 Value="{x:Static enums:FileUpdateType.Add}">
                                                <ChangePropertyAction PropertyName="Foreground" Value="Green" />
                                            </DataTriggerBehavior>
                                            <DataTriggerBehavior Binding="{Binding UpdateType}"
                                                                 Value="{x:Static enums:FileUpdateType.Delete}">
                                                <ChangePropertyAction PropertyName="Foreground" Value="Red" />
                                            </DataTriggerBehavior>
                                            <DataTriggerBehavior Binding="{Binding UpdateType}"
                                                                 Value="{x:Static enums:FileUpdateType.Modify}">
                                                <ChangePropertyAction PropertyName="Foreground" Value="Yellow" />
                                            </DataTriggerBehavior>
                                            <DataTriggerBehavior Binding="{Binding UpdateType}"
                                                                 Value="{x:Static enums:FileUpdateType.Move}">
                                                <ChangePropertyAction PropertyName="Foreground" Value="Orange" />
                                            </DataTriggerBehavior>
                                        </Interaction.Behaviors>
                                    </TextBlock>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn
                            Binding="{Binding Message}"
                            CanUserResize="False"
                            Header="信息"
                            IsReadOnly="True" />
                    </DataGrid.Columns>
                </DataGrid>

                <StackPanel
                    Grid.Row="4"
                    Margin="8,0"
                    HorizontalAlignment="Right"
                    Orientation="Horizontal"
                    Spacing="8">
                    <TextBlock VerticalAlignment="Center">
                        <Run Text="共新增文件" />
                        <Run Text="{Binding AddedFileCount, Mode=OneWay}" />
                        <Run Text="个（" />
                        <Run
                            Text="{Binding AddedFileLength, Mode=OneWay, Converter={StaticResource FileLength2StringConverter}}" />
                        <Run Text="），修改文件" />
                        <Run Text="{Binding ModifiedFileCount, Mode=OneWay}" />
                        <Run Text="个（" />
                        <Run
                            Text="{Binding ModifiedFileLength, Mode=OneWay, Converter={StaticResource FileLength2StringConverter}}" />
                        <Run Text="），移动文件" />
                        <Run Text="{Binding MovedFileCount, Mode=OneWay}" />
                        <Run Text="个，删除文件" />
                        <Run Text="{Binding DeletedFileCount, Mode=OneWay}" />
                        <Run Text="个" />
                    </TextBlock>

                    <Button
                        HorizontalAlignment="Stretch"
                        Content="全选"
                        Classes="Middle"
                        IsEnabled="{Binding CanEditConfigs}" />
                    <Button
                        Grid.Column="2"
                        Classes="Middle"
                        HorizontalAlignment="Stretch"
                        Content="全不选"
                        IsEnabled="{Binding CanEditConfigs}" />
                </StackPanel>
            </Grid>
            <Grid
                Grid.Row="99"
                Grid.ColumnSpan="99"
                Margin="8" ColumnDefinitions="*,8,*,8,Auto,8,Auto,8,Auto,8,Auto">
                <TextBlock
                    VerticalAlignment="Center"
                    Text="{Binding Message}"
                    TextTrimming="CharacterEllipsis"
                    ToolTip.Tip="{Binding Message}" />
                <ProgressBar
                    Grid.Column="2"
                    VerticalAlignment="Center"
                    IsIndeterminate="{Binding ProgressIndeterminate}"
                    Maximum="{Binding ProgressMax}"
                    Value="{Binding Progress}" />
                <TextBlock
                    Grid.Column="4"
                    VerticalAlignment="Center"
                    Text="导出方式：" />
                <ComboBox
                    Grid.Column="6"
                    Width="128"
                    ItemsSource="{Binding ExportModes}"
                    SelectedItem="{Binding ExportMode}">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock
                                VerticalAlignment="Center"
                                Text="{Binding ., Converter={StaticResource DescriptionConverter}}" />
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                    <ToolTip.Tip>
                        <TextBlock>
                            <Run FontWeight="Bold">复制：</Run>
                            <Run>将文件复制到导出目录中</Run>
                            <LineBreak />
                            <Run FontWeight="Bold">硬链接：</Run>
                            <Run>若本地目录与导出目录位于同一个本地的NTFS分区，可以创建链接来快速导出</Run>
                            <LineBreak />
                            <Run FontWeight="Bold">硬链接优先：</Run>
                            <Run>优先使用硬链接，若失败，则复制</Run>
                            <LineBreak />
                            <Run FontWeight="Bold">脚本：</Run>
                            <Run>将会在导出目录生成.bat和.ps1脚本，将执行脚本可以将需要的文件复制到脚本所在目录</Run>
                        </TextBlock>
                    </ToolTip.Tip>
                </ComboBox>
                <Button
                    Grid.Column="8"
                    Content="停止"
                    Classes="Long"
                    IsEnabled="{Binding CanStop}" />
                <Button
                    Grid.Column="10"
                    Classes="Long"
                    Command="{Binding ExportCommand}"
                    Content="3. 生成补丁"
                    IsEnabled="{Binding CanProcess}" />
            </Grid>
        </Grid>
    </v:OfflineSyncPanelBase.PanelContent>
</v:OfflineSyncPanelBase>